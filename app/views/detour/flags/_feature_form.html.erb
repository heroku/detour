<%= content_tag_for :tr, feature do %>
  <%= fields_for "features[#{feature}]", feature do |feature_form| %>
    <td>
      <% unless feature.new_record? %>
        <button type="button" class="btn btn-danger btn-xs delete-feature" data-path="<%= feature_path(feature.id, params: { flaggable_type: params[:flaggable_type] }) %>">
          <span class="glyphicon glyphicon-remove"></span>
        </button>
      <% end %>
    </td>

    <td><%= feature %></td>

    <%= render partial: "detour/shared/spacer_cells", locals: { tag: "td" } %>

    <% (@flag_form.database_groups + @flag_form.group_flags_for(feature)).sort_by { |g| g.respond_to?(:group_name) ? g.group_name.downcase : g.to_s.downcase }.each do |group_or_flag| %>
      <% if group_or_flag.is_a? Detour::Group %>
        <%= feature_form.fields_for "#{params[:flaggable_type]}_database_group_flags_attributes[#{group_or_flag.name}]", Detour::DatabaseGroupFlag.where(feature_id: feature.id, group_id: group_or_flag.id).first_or_initialize do |database_group_flag_form| %>
          <%= database_group_flag_form.hidden_field :id %>
          <td><%= database_group_flag_form.check_box :to_keep, data: { toggle: "tooltip", placement: "top", original_title: "#{group_or_flag.name}" } %></td>
        <% end %>
      <% else %>
        <%= feature_form.fields_for "#{params[:flaggable_type]}_group_flags_attributes[#{group_or_flag.group_name}]", group_or_flag do |group_flag_form| %>
          <%= group_flag_form.hidden_field :id %>
          <td><%= group_flag_form.check_box :to_keep, data: { toggle: "tooltip", placement: "top", original_title: "#{group_or_flag.group_name}" } %></td>
        <% end %>
      <% end %>
    <% end %>

    <%= feature_form.fields_for "#{params[:flaggable_type]}_percentage_flag_attributes", feature.send("#{params[:flaggable_type]}_percentage_flag") do |percentage_flag_form| %>
      <td><%= percentage_flag_form.text_field :percentage, class: "form-control input-sm" %></td>
    <% end %>

    <td class="flag-in-count">
      <%= link_to flag_in_flags_path(feature.name, params[:flaggable_type]) do %>
        <%= feature.flag_in_count_for(params[:flaggable_type]) %>
      <% end %>
    </td>

    <td class="opt-out-count">
      <%= link_to opt_out_flags_path(feature.name, params[:flaggable_type]) do %>
        <%= feature.opt_out_count_for(params[:flaggable_type]) %>
      <% end %>
    </td>
  <% end %>
<% end %>
